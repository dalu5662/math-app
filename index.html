<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes">
  <title>å°é˜¶æ•°å­¦Â·åº”ç”¨é¢˜ä¹å›­</title>
  
  <!-- å†…è”manifest - ä¿®å¤ç‰ˆ start_url="." -->
  <link rel="manifest" href="data:application/manifest+json,%7B%22name%22%3A%22%E5%B0%8F%E9%98%B6%E6%95%B0%E5%AD%A6%E2%80%A2%E5%BA%94%E7%94%A8%E9%A2%98%E4%B9%90%E5%9B%AD%22%2C%22short_name%22%3A%22%E6%95%B0%E5%AD%A6%E4%B9%90%E5%9B%AD%22%2C%22description%22%3A%22%E5%B0%8F%E5%AD%A6%E6%95%B0%E5%AD%A6%E5%BA%94%E7%94%A8%E9%A2%98%EF%BC%8C%E5%90%AB%E5%9F%BA%E7%A1%8011%E7%B1%BB%E5%92%8C%E5%A5%A5%E6%95%B08%E7%B1%BB%22%2C%22start_url%22%3A%22.%22%2C%22display%22%3A%22standalone%22%2C%22background_color%22%3A%22%23ff9f4b%22%2C%22theme_color%22%3A%22%23ff6b6b%22%2C%22icons%22%3A%5B%7B%22src%22%3A%22data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='48' fill='%23ff9f4b' stroke='%23ff6b6b' stroke-width='4'/%3E%3Ccircle cx='30' cy='35' r='8' fill='white'/%3E%3Ccircle cx='70' cy='35' r='8' fill='white'/%3E%3Ccircle cx='33' cy='38' r='4' fill='black'/%3E%3Ccircle cx='73' cy='38' r='4' fill='black'/%3E%3Cpath d='M30 65 Q50 80,70 65' stroke='%23ff6b6b' stroke-width='6' fill='none' stroke-linecap='round'/%3E%3Ctext x='40' y='30' font-size='22' fill='%23ff6b6b' font-weight='bold'%3E1+2%3C/text%3E%3C/svg%3E%22%2C%22sizes%22%3A%22192x192%22%2C%22type%22%3A%22image/svg+xml%22%7D%2C%7B%22src%22%3A%22data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='48' fill='%23ff9f4b' stroke='%23ff6b6b' stroke-width='4'/%3E%3Ccircle cx='30' cy='35' r='8' fill='white'/%3E%3Ccircle cx='70' cy='35' r='8' fill='white'/%3E%3Ccircle cx='33' cy='38' r='4' fill='black'/%3E%3Ccircle cx='73' cy='38' r='4' fill='black'/%3E%3Cpath d='M30 65 Q50 80,70 65' stroke='%23ff6b6b' stroke-width='6' fill='none' stroke-linecap='round'/%3E%3Ctext x='40' y='30' font-size='22' fill='%23ff6b6b' font-weight='bold'%3E1+2%3C/text%3E%3C/svg%3E%22%2C%22sizes%22%3A%22512x512%22%2C%22type%22%3A%22image/svg+xml%22%7D%5D%7D">
  
  <!-- è‹¹æœè®¾å¤‡ä¸“ç”¨å›¾æ ‡ -->
  <link rel="apple-touch-icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='48' fill='%23ff9f4b' stroke='%23ff6b6b' stroke-width='4'/%3E%3Ccircle cx='30' cy='35' r='8' fill='white'/%3E%3Ccircle cx='70' cy='35' r='8' fill='white'/%3E%3Ccircle cx='33' cy='38' r='4' fill='black'/%3E%3Ccircle cx='73' cy='38' r='4' fill='black'/%3E%3Cpath d='M30 65 Q50 80,70 65' stroke='%23ff6b6b' stroke-width='6' fill='none' stroke-linecap='round'/%3E%3Ctext x='40' y='30' font-size='22' fill='%23ff6b6b' font-weight='bold'%3E1+2%3C/text%3E%3C/svg%3E">
  
  <!-- PWAå¿…è¦meta -->
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="theme-color" content="#ff6b6b">
  
  <!-- å¤‡ç”¨favicon -->
  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='48' fill='%23ff9f4b' stroke='%23ff6b6b' stroke-width='4'/%3E%3Ccircle cx='30' cy='35' r='8' fill='white'/%3E%3Ccircle cx='70' cy='35' r='8' fill='white'/%3E%3Ccircle cx='33' cy='38' r='4' fill='black'/%3E%3Ccircle cx='73' cy='38' r='4' fill='black'/%3E%3Cpath d='M30 65 Q50 80,70 65' stroke='%23ff6b6b' stroke-width='6' fill='none' stroke-linecap='round'/%3E%3Ctext x='40' y='30' font-size='22' fill='%23ff6b6b' font-weight='bold'%3E1+2%3C/text%3E%3C/svg%3E">
  
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    body {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      font-family: 'Comic Sans MS', 'Chalkboard SE', 'å¹¼åœ†', Yuanti SC, system-ui, sans-serif;
      min-height: 100vh;
      display: flex;
      justify-content: center;
      padding: 15px;
    }
    
    .app-container {
      max-width: 1000px;
      width: 100%;
      background: rgba(255, 255, 255, 0.95);
      border-radius: 60px 60px 40px 40px;
      padding: 25px 20px;
      box-shadow: 0 30px 40px rgba(0,0,0,0.2), 0 0 0 5px #ffd93d;
      backdrop-filter: blur(10px);
      position: relative;
    }
    
    .app-container::before {
      content: 'ğŸ¼ ğŸ¨ ğŸ»â€â„ï¸';
      position: absolute;
      top: -30px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 30px;
      background: #ffd93d;
      padding: 5px 25px;
      border-radius: 50px;
      box-shadow: 0 5px 0 #ff9f4b;
    }
    
    .title-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 15px;
      margin: 20px 0 15px 0;
      background: #ffd93d;
      padding: 15px 25px;
      border-radius: 60px;
      border: 4px solid #ff9f4b;
    }
    
    .title-main {
      display: flex;
      align-items: center;
      gap: 15px;
    }
    
    .title-main span:first-child {
      font-size: 3rem;
      filter: drop-shadow(2px 4px 0 #ff6b6b);
    }
    
    .title-main span:last-child {
      font-size: 2rem;
      font-weight: 800;
      color: #4a4a4a;
      text-shadow: 3px 3px 0 #ff9f4b;
    }
    
    .install-btn {
      background: #ff6b6b;
      color: white;
      border: none;
      padding: 12px 25px;
      border-radius: 40px;
      font-size: 1.2rem;
      font-weight: 800;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 10px;
      box-shadow: 0 6px 0 #b23b3b;
      transition: 0.1s;
      border: 3px solid white;
      font-family: inherit;
    }
    
    .install-btn:active {
      transform: translateY(6px);
      box-shadow: none;
    }
    
    .install-btn.hidden {
      display: none;
    }
    
    .subtitle {
      background: #9b87f5;
      color: white;
      padding: 15px 25px;
      border-radius: 40px;
      margin-bottom: 20px;
      font-size: 1.2rem;
      font-weight: 600;
      text-align: center;
      border: 4px solid #6c5ce7;
      box-shadow: 0 5px 0 #4a3f9e;
    }
    
    .card {
      background: #f8f9ff;
      border-radius: 50px;
      padding: 25px 20px;
      margin: 20px 0;
      border: 4px solid #a990fb;
      box-shadow: 0 8px 0 #6c5ce7;
    }
    
    .flex-row {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      align-items: center;
      justify-content: space-between;
    }
    
    .timer-card {
      background: #2c3e50;
      color: #ffd93d;
      border-radius: 50px;
      padding: 15px 30px;
      box-shadow: 0 8px 0 #1a2632;
      border: 4px solid #ff9f4b;
    }
    
    .timer-display {
      font-size: 3.5rem;
      font-weight: 800;
      letter-spacing: 8px;
      font-family: 'Courier New', monospace;
      text-shadow: 0 0 10px #ffd93d;
    }
    
    button {
      background: #9b87f5;
      border: none;
      color: white;
      font-weight: 800;
      padding: 15px 30px;
      border-radius: 50px;
      font-size: 1.2rem;
      box-shadow: 0 6px 0 #6c5ce7;
      cursor: pointer;
      border: 3px solid white;
      transition: 0.1s;
      font-family: inherit;
    }
    
    button:active {
      transform: translateY(6px);
      box-shadow: none;
    }
    
    button:disabled {
      opacity: 0.5;
      transform: none;
      box-shadow: 0 6px 0 #6c5ce7;
      pointer-events: none;
    }
    
    .diff-pill {
      display: flex;
      background: white;
      border-radius: 60px;
      border: 4px solid #ff9f4b;
      overflow: hidden;
    }
    
    .diff-pill label {
      padding: 12px 28px;
      cursor: pointer;
      font-size: 1.2rem;
      font-weight: 700;
      transition: 0.1s;
    }
    
    input[type="radio"] { display: none; }
    input[type="radio"]:checked + span { 
      background: #ffd93d; 
      color: #4a4a4a;
      display: block;
      padding: 12px 28px;
      margin: -12px -28px;
    }
    
    .ques-item {
      background: #fff9e6;
      border-radius: 40px;
      padding: 20px;
      margin-bottom: 15px;
      border: 4px solid #ffd93d;
      box-shadow: 0 5px 0 #ff9f4b;
    }
    
    .ques-header {
      display: flex;
      flex-wrap: wrap;
      align-items: baseline;
      gap: 10px;
      margin-bottom: 15px;
    }
    
    .ques-text {
      font-size: 1.3rem;
      font-weight: 600;
      color: #4a4a4a;
    }
    
    .meta-badge {
      background: #9b87f5;
      color: white;
      border-radius: 40px;
      padding: 8px 20px;
      font-size: 1rem;
      font-weight: 700;
      border: 3px solid white;
    }
    
    .answer-area {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 15px;
      margin-bottom: 15px;
    }
    
    .ans-input {
      width: 150px;
      padding: 12px 20px;
      border-radius: 50px;
      border: 4px solid #ff9f4b;
      font-size: 1.2rem;
      text-align: center;
      font-family: inherit;
    }
    
    .result-badge {
      font-weight: 800;
      padding: 10px 25px;
      border-radius: 40px;
      font-size: 1.1rem;
      border: 3px solid white;
    }
    
    .correct-badge { background: #8bc34a; color: white; }
    .wrong-badge { background: #ff6b6b; color: white; }
    .pending-badge { background: #ffd93d; color: #4a4a4a; }
    
    /* åŒå±‚æç¤ºæ ·å¼ */
    .hint-section {
      margin-top: 15px;
      border-top: 2px dashed #ff9f4b;
      padding-top: 15px;
    }
    
    .child-hint {
      background: #e3f2fd;
      border-radius: 30px;
      padding: 12px 18px;
      font-size: 1.1rem;
      border-left: 8px solid #2196f3;
      color: #0d3c61;
      margin-bottom: 10px;
    }
    
    .parent-hint {
      background: #fff3e0;
      border-radius: 30px;
      padding: 12px 18px;
      font-size: 1rem;
      border-left: 8px solid #ff9800;
      color: #663c00;
      margin-top: 10px;
    }
    
    .parent-btn {
      background: #ff9800;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 30px;
      font-size: 0.9rem;
      font-weight: 600;
      cursor: pointer;
      box-shadow: 0 3px 0 #b26a00;
      transition: 0.1s;
      border: 2px solid white;
    }
    
    .parent-btn:active {
      transform: translateY(3px);
      box-shadow: none;
    }
    
    .hidden {
      display: none;
    }
    
    .history-panel {
      background: #2c3e50;
      color: #ffd93d;
      border-radius: 40px;
      padding: 20px;
      font-size: 1rem;
      max-height: 180px;
      overflow-y: auto;
      border: 4px solid #ff9f4b;
    }
    
    .mistake-panel {
      background: #fff0f0;
      border: 6px dashed #ff6b6b;
      border-radius: 50px;
      padding: 20px;
      margin: 20px 0;
    }
    
    .mistake-item {
      background: white;
      border-radius: 30px;
      padding: 12px 18px;
      margin-bottom: 10px;
      border: 2px solid #ff6b6b;
    }
    
    .footer-actions {
      display: flex;
      gap: 15px;
      flex-wrap: wrap;
      margin-top: 20px;
    }
    
    hr {
      border: 4px solid #ffd93d;
      border-radius: 10px;
      margin: 30px 0;
    }
    
    .deco-animals {
      display: flex;
      justify-content: space-around;
      margin: 10px 0;
      font-size: 2rem;
    }
  </style>
</head>
<body>
<div class="app-container">
  <div class="deco-animals">
    <span>ğŸ˜</span> <span>ğŸ¦’</span> <span>ğŸ¦</span> <span>ğŸ¯</span> <span>ğŸ¸</span>
  </div>
  
  <div class="title-row">
    <div class="title-main">
      <span>ğŸ§®</span>
      <span>æ•°å­¦åº”ç”¨é¢˜ä¹å›­</span>
    </div>
    <button class="install-btn" id="installBtn">
      ğŸ“² å®‰è£…åˆ°è®¾å¤‡
    </button>
  </div>
  
  <div class="subtitle">
    ğŸŒŸ åŸºç¡€11ç±» Â· ğŸ¯ å¥¥æ•°8ç±» Â· ğŸ“ é”™é¢˜æœ¬ Â· ğŸ’¡ åŒå±‚æç¤º
  </div>

  <div class="card">
    <div class="flex-row">
      <div class="diff-pill">
        <label><input type="radio" name="diff" value="åˆçº§" checked><span>ğŸ£ åˆçº§</span></label>
        <label><input type="radio" name="diff" value="ä¸­çº§"><span>ğŸ¦Š ä¸­çº§</span></label>
        <label><input type="radio" name="diff" value="é«˜çº§"><span>ğŸ¦‰ é«˜çº§</span></label>
      </div>
      <button id="startBtn">ğŸš€ å¼€å§‹20åˆ†é’ŸæŒ‘æˆ˜</button>
    </div>
    <div class="flex-row" style="margin-top: 25px;">
      <div class="timer-card"><span class="timer-display" id="timer">20:00</span></div>
      <button id="submitBtn" disabled>âœ… æäº¤æ‰€æœ‰ç­”æ¡ˆ</button>
    </div>
  </div>

  <div id="questionsContainer">
    <div class="ques-item" style="text-align:center; padding:40px;">
      ğŸ® ç‚¹å‡»"å¼€å§‹20åˆ†é’ŸæŒ‘æˆ˜"ç”Ÿæˆé¢˜ç›®
    </div>
  </div>

  <hr>
  <div style="display: flex; justify-content: space-between; align-items: center; margin: 20px 0;">
    <h2 style="color:#4a4a4a; font-size:2rem;">ğŸ“‹ ç»ƒä¹ è®°å½•</h2>
    <button id="clearMistakesBtn" style="background:#ff6b6b; box-shadow:0 6px 0 #b23b3b;">ğŸ—‘ï¸ æ¸…ç©ºé”™é¢˜</button>
  </div>
  <div class="history-panel" id="historyLog">æš‚æ— ç»ƒä¹ è®°å½•</div>
  <div class="mistake-panel" id="mistakeContainer">ğŸ“• è¿˜æ²¡æœ‰é”™é¢˜ï¼Œç»§ç»­åŠ æ²¹ï¼</div>

  <div class="footer-actions">
    <button id="exportBtn" style="background:#6c5ce7;">ğŸ“ å¯¼å‡ºé”™é¢˜</button>
    <button id="demoBtn" style="background:#ff9f4b;">ğŸ§ª æ·»åŠ ç¤ºä¾‹é”™é¢˜</button>
    <span style="flex:1; text-align:right; font-size:1rem; color:#4a4a4a;">ğŸ¼ å¿«ä¹å­¦æ•°å­¦ v3.7</span>
  </div>
</div>

<script>
(function(){
  // ========== åŸºç¡€é¢˜åº“æ¨¡æ¿ ==========
  const BASE_TEMPLATES = [
    {
      type: "å½’ä¸€",
      generate: () => {
        const pencils = Math.floor(Math.random() * 8) + 3;
        const price = (Math.floor(Math.random() * 15) + 10) * pencils;
        const unitPrice = price / pencils;
        const buyNum = Math.floor(Math.random() * 10) + 5;
        return {
          text: `ğŸ§ ä¹°${pencils}æ”¯é“…ç¬”${price}å…ƒï¼Œä¹°${buyNum}æ”¯éœ€å¤šå°‘å…ƒï¼Ÿ`,
          ans: unitPrice * buyNum,
          childHint: `ğŸ¤” å…ˆæƒ³æƒ³ï¼š1æ”¯é“…ç¬”å¤šå°‘é’±ï¼Ÿç„¶åå†ç®—${buyNum}æ”¯çš„é’±ã€‚`,
          parentHint: `å…ˆæ±‚1æ”¯ä»·æ ¼ï¼š${price}Ã·${pencils}=${unitPrice}å…ƒï¼Œå†ä¹˜${buyNum}å¾—${unitPrice * buyNum}å…ƒ`
        };
      }
    },
    {
      type: "å½’æ€»",
      generate: () => {
        const days = Math.floor(Math.random() * 7) + 6;
        const perDay = Math.floor(Math.random() * 6) + 8;
        const total = days * perDay;
        const newPerDay = Math.floor(Math.random() * 8) + 10;
        return {
          text: `ğŸ¦Š ä¿®è·¯æ¯å¤©${perDay}ç±³ï¼Œ${days}å¤©å®Œã€‚æ¯å¤©${newPerDay}ç±³ï¼Œéœ€å‡ å¤©ï¼Ÿ`,
          ans: Math.ceil(total / newPerDay),
          childHint: `ğŸ¤” è¿™æ¡è·¯ä¸€å…±å¤šé•¿ï¼Ÿç”¨æ€»é•¿åº¦é™¤ä»¥æ–°çš„æ¯å¤©é•¿åº¦ã€‚`,
          parentHint: `å…¨é•¿${total}ç±³ï¼Œ${total}Ã·${newPerDay}=${Math.ceil(total / newPerDay)}å¤©`
        };
      }
    },
    {
      type: "å’Œå·®",
      generate: () => {
        const sum = Math.floor(Math.random() * 30) + 15;
        const diff = Math.floor(Math.random() * 8) + 2;
        const small = (sum - diff) / 2;
        return {
          text: `ğŸ¼ å°çº¢å’Œå°æ˜å…±${sum}é¢—ç³–ï¼Œå°çº¢æ¯”å°æ˜å¤š${diff}é¢—ï¼Œå°æ˜æœ‰å‡ é¢—ï¼Ÿ`,
          ans: small,
          childHint: `ğŸ¤” å¦‚æœä¸¤äººä¸€æ ·å¤šï¼Œæ€»æ•°ä¼šæ˜¯å¤šå°‘ï¼Ÿå¤šçš„é‚£éƒ¨åˆ†æ€ä¹ˆå¤„ç†ï¼Ÿ`,
          parentHint: `å°æ•°=(å’Œ-å·®)Ã·2 = (${sum}-${diff})Ã·2=${small}`
        };
      }
    },
    {
      type: "å’Œå€",
      generate: () => {
        const sum = Math.floor(Math.random() * 150) + 50;
        const multiple = Math.floor(Math.random() * 4) + 2;
        const small = sum / (multiple + 1);
        return {
          text: `ğŸ¦ æ•…äº‹ä¹¦+ç§‘æŠ€ä¹¦=${sum}æœ¬ï¼Œæ•…äº‹ä¹¦æ˜¯ç§‘æŠ€ä¹¦${multiple}å€ï¼Œç§‘æŠ€ä¹¦å‡ æœ¬ï¼Ÿ`,
          ans: small,
          childHint: `ğŸ¤” ç§‘æŠ€ä¹¦æ˜¯1ä»½ï¼Œæ•…äº‹ä¹¦æ˜¯å‡ ä»½ï¼Ÿæ€»å…±å‡ ä»½ï¼Ÿ`,
          parentHint: `ç§‘æŠ€ä¹¦1ä»½ï¼Œæ•…äº‹ä¹¦${multiple}ä»½ï¼Œå…±${multiple+1}ä»½=${sum}ï¼Œ1ä»½=${small}`
        };
      }
    },
    {
      type: "å·®å€",
      generate: () => {
        const diff = Math.floor(Math.random() * 20) + 20;
        const multiple = Math.floor(Math.random() * 3) + 2;
        const small = diff / (multiple - 1);
        return {
          text: `ğŸ¨ å¦ˆå¦ˆå¹´é¾„æ˜¯å°çº¢çš„${multiple}å€ï¼Œæ¯”å°çº¢å¤§${diff}å²ï¼Œå°çº¢å‡ å²ï¼Ÿ`,
          ans: small,
          childHint: `ğŸ¤” å¦ˆå¦ˆæ¯”å°çº¢å¤§çš„éƒ¨åˆ†ï¼Œç›¸å½“äºå°çº¢çš„å‡ å€ï¼Ÿ`,
          parentHint: `å·®å€: ${diff}Ã·(${multiple}-1)=${small}`
        };
      }
    },
    {
      type: "è¡Œç¨‹",
      generate: () => {
        const distance = Math.floor(Math.random() * 200) + 100;
        const speed = Math.floor(Math.random() * 30) + 40;
        return {
          text: `ğŸ˜ ç”²ä¹™ç›¸è·${distance}kmï¼Œé€Ÿåº¦${speed}km/hï¼Œå‡ å°æ—¶åˆ°è¾¾ï¼Ÿ`,
          ans: Math.round(distance / speed * 10) / 10,
          childHint: `ğŸ¤” æ—¶é—´ = è·¯ç¨‹ Ã· é€Ÿåº¦ï¼Œä½ ä¼šç®—å—ï¼Ÿ`,
          parentHint: `æ—¶é—´=è·¯ç¨‹Ã·é€Ÿåº¦=${distance}Ã·${speed}=${Math.round(distance / speed * 10) / 10}å°æ—¶`
        };
      }
    },
    {
      type: "æ¤æ ‘",
      generate: () => {
        const interval = Math.floor(Math.random() * 8) + 5;
        const segments = Math.floor(Math.random() * 10) + 5;
        const length = interval * segments;
        return {
          text: `ğŸ¦’ å°è·¯${length}ç±³ï¼Œæ¯éš”${interval}ç±³æ ½æ ‘(ä¸¤ç«¯éƒ½æ ½)ï¼Œéœ€å¤šå°‘æ£µï¼Ÿ`,
          ans: segments + 1,
          childHint: `ğŸ¤” æŠŠè·¯åˆ†æˆ${interval}ç±³ä¸€æ®µï¼Œå¯ä»¥åˆ†æˆå‡ æ®µï¼Ÿä¸¤ç«¯éƒ½æ ½æ ‘ï¼Œæ£µæ•°æ¯”æ®µæ•°å¤šå‡ ï¼Ÿ`,
          parentHint: `æ®µæ•°=${length}Ã·${interval}=${segments}æ®µï¼Œä¸¤ç«¯éƒ½æ ½ï¼šæ£µæ•°=æ®µæ•°+1=${segments + 1}æ£µ`
        };
      }
    },
    {
      type: "å¹´é¾„",
      generate: () => {
        const son = Math.floor(Math.random() * 5) + 5;
        let father, multiple, years;
        do {
          multiple = Math.floor(Math.random() * 2) + 2;
          const baseDiff = (Math.floor(Math.random() * 5) + 3) * (multiple - 1);
          father = son + baseDiff;
          years = (father - son * multiple) / (multiple - 1);
        } while (years <= 0 || years > 15 || Math.floor(years) !== years);
        return {
          text: `ğŸ¸ çˆ¶äº²${father}ï¼Œå„¿å­${son}ï¼Œå‡ å¹´åçˆ¶äº²æ˜¯å„¿å­${multiple}å€ï¼Ÿ`,
          ans: years,
          childHint: `ğŸ¤” å¹´é¾„å·®æ°¸è¿œä¸å˜ï¼Œå‡ å¹´åå„¿å­å¤šå°‘å²æ—¶çˆ¶äº²æ˜¯ä»–çš„${multiple}å€ï¼Ÿ`,
          parentHint: `å¹´é¾„å·®${father - son}ä¸å˜ï¼Œå„¿å­${son + years}å²æ—¶ï¼Œçˆ¶äº²${father + years}å²ï¼Œ${years}å¹´å`
        };
      }
    },
    {
      type: "é¸¡å…”åŒç¬¼",
      generate: () => {
        const heads = Math.floor(Math.random() * 15) + 5;
        const rabbits = Math.floor(Math.random() * 8) + 2;
        const chickens = heads - rabbits;
        const legs = rabbits * 4 + chickens * 2;
        return {
          text: `ğŸ é¸¡å…”å…±${heads}åªï¼Œè…¿${legs}æ¡ï¼Œå…”å‡ åªï¼Ÿ`,
          ans: rabbits,
          childHint: `ğŸ¤” å‡è®¾å…¨æ˜¯é¸¡æœ‰å¤šå°‘æ¡è…¿ï¼Ÿæ¯”å®é™…å°‘å¤šå°‘ï¼Ÿæ¯æ¢ä¸€åªå…”å¤šå‡ æ¡è…¿ï¼Ÿ`,
          parentHint: `å‡è®¾å…¨æ˜¯é¸¡:${heads * 2}è…¿ï¼Œå¤š${legs - heads * 2}è…¿æ¢å…”ï¼Œå…”=${(legs - heads * 2) / 2}`
        };
      }
    },
    {
      type: "ç›ˆäº",
      generate: () => {
        const people = Math.floor(Math.random() * 8) + 4;
        const per1 = Math.floor(Math.random() * 3) + 2;
        const per2 = per1 + 1;
        const total1 = people * per1;
        constç›ˆ = Math.floor(Math.random() * 8) + 2;
        constäº = total1 + ç›ˆ - people * per2;
        return {
          text: `ğŸ¦‹ æ¯äººåˆ†${per1}ä¸ªå¤š${ç›ˆ}ä¸ªï¼Œæ¯äºº${per2}ä¸ªå°‘${äº}ä¸ªï¼Œå°æœ‹å‹å‡ äººï¼Ÿ`,
          ans: people,
          childHint: `ğŸ¤” ä¸¤æ¬¡åˆ†é…ç›¸å·®å‡ ä¸ªï¼Ÿæ¯äººå¤šåˆ†å‡ ä¸ªï¼Ÿäººæ•°æ€ä¹ˆæ±‚ï¼Ÿ`,
          parentHint: `(ç›ˆ+äº)Ã·åˆ†é…å·®=(${ç›ˆ}+${äº})Ã·(${per2}-${per1})=${people}`
        };
      }
    },
    {
      type: "åˆ†æ•°",
      generate: () => {
        const total = Math.floor(Math.random() * 100) + 50;
        const numerator = Math.floor(Math.random() * 3) + 1;
        const denominator = Math.floor(Math.random() * 3) + 4;
        return {
          text: `ğŸ è·¯å…¨é•¿${total}ç±³ï¼Œä¿®äº†${numerator}/${denominator}ï¼Œä¿®äº†å¤šå°‘ç±³ï¼Ÿ`,
          ans: total * numerator / denominator,
          childHint: `ğŸ¤” æ±‚ä¸€ä¸ªæ•°çš„å‡ åˆ†ä¹‹å‡ æ˜¯å¤šå°‘ï¼Œç”¨ä»€ä¹ˆæ–¹æ³•ï¼Ÿ`,
          parentHint: `${total} Ã— ${numerator}/${denominator} = ${total * numerator / denominator}`
        };
      }
    }
  ];

  // ========== å¥¥æ•°é¢˜åº“æ¨¡æ¿ ==========
  const OLYMPIC_TEMPLATES = [
    {
      type: "å‘¨æœŸé—®é¢˜",
      generate: () => {
        const colors = [["çº¢","é»„","è“","ç»¿"], ["çº¢","é»„","è“"], ["çº¢","è“","ç»¿"]];
        const selected = colors[Math.floor(Math.random() * colors.length)];
        const index = Math.floor(Math.random() * 30) + 10;
        const remainder = index % selected.length;
        const color = selected[remainder === 0 ? selected.length - 1 : remainder - 1];
        return {
          text: `ğŸ¨ å½©ç¯${selected.join('')}å¾ªç¯ï¼Œç¬¬${index}ç›é¢œè‰²ï¼Ÿ(å†™æ±‰å­—: ${selected.join('/')})`,
          ans: color,
          childHint: `ğŸ¤” å‡ ä¸ªé¢œè‰²ä¸€ç»„å¾ªç¯ï¼Ÿç¬¬${index}ä¸ªæ˜¯ç¬¬å‡ ç»„çš„ç¬¬å‡ ä¸ªï¼Ÿ`,
          parentHint: `å‘¨æœŸ${selected.length}ï¼Œ${index}Ã·${selected.length}ä½™${index % selected.length} â†’ ç¬¬${index % selected.length || selected.length}ä¸ª: ${color}`
        };
      }
    },
    {
      type: "æ•°åˆ—",
      generate: () => {
        const start = Math.floor(Math.random() * 5) + 1;
        const step = Math.floor(Math.random() * 4) + 2;
        const numbers = [];
        for(let i=0; i<5; i++) {
          numbers.push(start + i * step);
        }
        const missingIndex = Math.floor(Math.random() * 3) + 1;
        const answer = numbers[missingIndex];
        numbers[missingIndex] = "?";
        return {
          text: `ğŸ”¢ ${numbers.join(',')} ç¼ºå°‘çš„æ•°å­—æ˜¯ï¼Ÿ`,
          ans: answer,
          childHint: `ğŸ¤” è§‚å¯Ÿç›¸é‚»ä¸¤ä¸ªæ•°çš„å·®ï¼Œæ‰¾å‡ºè§„å¾‹ã€‚`,
          parentHint: `ç­‰å·®æ•°åˆ—ï¼Œå…¬å·®${step}ï¼Œ?=${answer}`
        };
      }
    },
    {
      type: "ä¹˜æ³•åŸç†",
      generate: () => {
        const a2b = Math.floor(Math.random() * 4) + 2;
        const b2c = Math.floor(Math.random() * 4) + 3;
        return {
          text: `ğŸ›£ï¸ Aåˆ°Bæœ‰${a2b}æ¡è·¯ï¼ŒBåˆ°Cæœ‰${b2c}æ¡ï¼ŒAç»Båˆ°Cå…±å‡ ç§èµ°æ³•ï¼Ÿ`,
          ans: a2b * b2c,
          childHint: `ğŸ¤” å…ˆé€‰Aåˆ°Bçš„è·¯ï¼Œå†é€‰Båˆ°Cçš„è·¯ï¼Œä¸€å…±å¤šå°‘ç§ç»„åˆï¼Ÿ`,
          parentHint: `åˆ†æ­¥è®¡æ•° ${a2b}Ã—${b2c}=${a2b * b2c}`
        };
      }
    },
    {
      type: "æœ€ä¼˜åŒ–é—®é¢˜",
      generate: () => {
        return {
          text: `ğŸ³ çƒ™é¥¼æ¯æ¬¡æ”¾2å¼ ï¼Œæ¯é¢3åˆ†é’Ÿï¼Œ3å¼ é¥¼è‡³å°‘å‡ åˆ†é’Ÿï¼Ÿ`,
          ans: 9,
          childHint: `ğŸ¤” æ€æ ·è®©é”…ä¸ç©ºç€ï¼Ÿå¯ä»¥äº¤æ›¿çƒ™é¥¼ã€‚`,
          parentHint: `äº¤æ›¿æ³•: 3å¼ å…±éœ€3Ã—3=9åˆ†é’Ÿ`
        };
      }
    },
    {
      type: "åˆ—æ–¹ç¨‹",
      generate: () => {
        const x = Math.floor(Math.random() * 6) + 2;
        const a = Math.floor(Math.random() * 3) + 2;
        const b = Math.floor(Math.random() * 6) + 2;
        return {
          text: `â“ æŸæ•°çš„${a}å€åŠ ${b}ç­‰äºå®ƒçš„${a*2}å€å‡${b}ï¼Œæ±‚è¿™ä¸ªæ•°ã€‚`,
          ans: x,
          childHint: `ğŸ¤” è®¾è¿™ä¸ªæ•°ä¸ºxï¼Œåˆ—å‡ºæ–¹ç¨‹ï¼Œä¸¤è¾¹åŒæ—¶åŠ å‡ã€‚`,
          parentHint: `${a}x+${b}=${a*2}x-${b} â†’ ${a*2}x-${a}x=${b}+${b} â†’ ${a}x=${b*2} â†’ x=${x}`
        };
      }
    },
    {
      type: "é€»è¾‘æ¨ç†",
      generate: () => {
        const subjects = ["è¯­æ–‡", "æ•°å­¦", "éŸ³ä¹"];
        const shuffled = [...subjects];
        for(let i=shuffled.length-1; i>0; i--) {
          const j = Math.floor(Math.random() * (i+1));
          [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
        }
        return {
          text: `ğŸ§© å°çº¢ä¸å–œæ¬¢${shuffled[0]}ï¼Œå°ä¸½å–œæ¬¢${shuffled[2]}ï¼Œå°èŠ³ä¸æ˜¯ä¸å–œæ¬¢${shuffled[1]}ã€‚å°çº¢å–œæ¬¢ä»€ä¹ˆï¼Ÿ(å†™æ±‰å­—: ${subjects.join('/')})`,
          ans: shuffled[1],
          childHint: `ğŸ¤” ç”¨è¡¨æ ¼æ³•ï¼Œå…ˆç¡®å®šå°ä¸½çš„ï¼Œå†æ’é™¤å°çº¢çš„ã€‚`,
          parentHint: `å°ä¸½=${shuffled[2]}ï¼Œå°çº¢â‰ ${shuffled[0]}ï¼Œåˆ™å°çº¢=${shuffled[1]}`
        };
      }
    },
    {
      type: "å®¹æ–¥åŸç†",
      generate: () => {
        const a = Math.floor(Math.random() * 8) + 12;
        const b = Math.floor(Math.random() * 8) + 15;
        const both = Math.floor(Math.random() * 6) + 4;
        const total = a + b - both;
        return {
          text: `ğŸ“Š ä½œæ–‡ç­${a}äººï¼Œå¥¥æ•°ç­${b}äººï¼Œå…±${total}äººï¼Œä¸¤ç­éƒ½å‚åŠ å‡ äººï¼Ÿ`,
          ans: both,
          childHint: `ğŸ¤” æ€»äººæ•° = ä½œæ–‡ç­ + å¥¥æ•°ç­ - éƒ½å‚åŠ çš„äººæ•°ã€‚`,
          parentHint: `${a}+${b}-${total}=${both}`
        };
      }
    },
    {
      type: "å·§æ±‚å‘¨é•¿",
      generate: () => {
        const length = Math.floor(Math.random() * 8) + 6;
        const width = Math.floor(Math.random() * 5) + 4;
        const hole = Math.floor(Math.random() * 2) + 1;
        const original = (length + width) * 2;
        return {
          text: `ğŸ“ é•¿${length}å®½${width}é•¿æ–¹å½¢æŒ–æ‰è¾¹é•¿${hole}æ­£æ–¹å½¢(å†…éƒ¨)ï¼Œå‰©ä½™å‘¨é•¿ï¼Ÿ(å•ä½cm)`,
          ans: original + hole * 2,
          childHint: `ğŸ¤” æŒ–æ‰ä¸€ä¸ªæ­£æ–¹å½¢åï¼Œå‘¨é•¿ä¼šå¢åŠ è¿˜æ˜¯å‡å°‘ï¼Ÿå¢åŠ äº†å¤šå°‘ï¼Ÿ`,
          parentHint: `åŸå‘¨é•¿${original}ï¼Œå‡¹è¿›å¢åŠ ${hole*2}ï¼Œæ€»${original + hole*2}`
        };
      }
    },
    {
      type: "å‘¨æœŸ",
      generate: () => {
        const colors = ["çº¢", "é»„", "è“"];
        const index = Math.floor(Math.random() * 30) + 15;
        const remainder = index % 3;
        const color = colors[remainder === 0 ? 2 : remainder - 1];
        return {
          text: `ğŸ¨ ${colors.join('')}é‡å¤ï¼Œç¬¬${index}ç›ç¯é¢œè‰²ï¼Ÿ(å†™æ±‰å­—: çº¢/é»„/è“)`,
          ans: color,
          childHint: `ğŸ¤” 3ä¸ªä¸€ç»„å¾ªç¯ï¼Œçœ‹ç¬¬${index}ä¸ªæ˜¯ç¬¬å‡ ç»„çš„ç¬¬å‡ ä¸ªã€‚`,
          parentHint: `${index}Ã·3ä½™${index % 3}ï¼Œç¬¬${index % 3 || 3}ä¸ª: ${color}`
        };
      }
    }
  ];

  function generateQuestionsFromTemplates(templates, count) {
    const shuffled = [...templates];
    for (let i = shuffled.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
    }
    return shuffled.slice(0, count).map(template => {
      const generated = template.generate();
      return {
        ...generated,
        mainCat: BASE_TEMPLATES.includes(template) ? "åŸºç¡€é¢˜" : "å¥¥æ•°é¢˜",
        subCat: template.type,
        userAnswer: null,
        isCorrect: null
      };
    });
  }

  window.toggleParentHint = function(idx) {
    const hintDiv = document.getElementById(`parentHint_${idx}`);
    if (hintDiv) hintDiv.classList.toggle('hidden');
  };

  const app = {
    currentQuestions: [],
    timerInterval: null,
    secondsLeft: 1200,
    active: false,
    difficulty: 'åˆçº§',
    mistakeList: [],
    deferredPrompt: null,
    submitted: false,

    init: function() {
      window.addEventListener('beforeinstallprompt', (e) => {
        e.preventDefault();
        this.deferredPrompt = e;
        document.getElementById('installBtn').classList.remove('hidden');
      });

      document.getElementById('installBtn').addEventListener('click', () => {
        if (!this.deferredPrompt) {
          alert('è¯·ä½¿ç”¨æµè§ˆå™¨èœå•ä¸­çš„ã€Œå®‰è£…ã€æˆ–ã€Œæ·»åŠ åˆ°ä¸»å±å¹•ã€åŠŸèƒ½');
          return;
        }
        this.deferredPrompt.prompt();
        this.deferredPrompt.userChoice.then(() => {
          this.deferredPrompt = null;
          document.getElementById('installBtn').style.display = 'none';
        });
      });

      document.getElementById('startBtn').addEventListener('click', () => this.startNew());
      document.getElementById('submitBtn').addEventListener('click', () => this.submitAll());
      document.getElementById('clearMistakesBtn').addEventListener('click', () => this.clearMistakes());
      document.getElementById('exportBtn').addEventListener('click', () => this.exportMistakes());
      document.getElementById('demoBtn').addEventListener('click', () => this.addDemoMistake());

      document.querySelectorAll('input[name="diff"]').forEach(r => {
        r.addEventListener('change', (e) => { this.difficulty = e.target.value; });
      });

      this.loadMistakes();
    },

    startNew: function() {
      if(this.timerInterval) clearInterval(this.timerInterval);
      this.secondsLeft = 1200;
      this.active = true;
      this.submitted = false;
      this.updateTimer();
      this.generatePaper();
      this.timerInterval = setInterval(() => this.tick(), 1000);
      document.getElementById('submitBtn').disabled = false;
      document.getElementById('startBtn').disabled = true;
      this.addLog(`â–¶ å¼€å§‹ ${this.difficulty} éš¾åº¦ç»ƒä¹ `);
    },

    tick: function() {
      if(!this.active) return;
      this.secondsLeft--;
      this.updateTimer();
      if(this.secondsLeft <= 0) {
        this.secondsLeft = 0;
        this.updateTimer();
        this.active = false;
        clearInterval(this.timerInterval);
        document.getElementById('startBtn').disabled = false;
        document.getElementById('submitBtn').disabled = true;
        this.addLog("âŒ› æ—¶é—´åˆ°ï¼Œç»ƒä¹ ç»“æŸ");
      }
    },

    updateTimer: function() {
      const m = Math.floor(this.secondsLeft / 60);
      const s = this.secondsLeft % 60;
      document.getElementById('timer').innerText = `${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
    },

    generatePaper: function() {
      const totalQuestions = 6;
      if (this.difficulty === 'åˆçº§') {
        this.currentQuestions = generateQuestionsFromTemplates(BASE_TEMPLATES, totalQuestions);
      } else if (this.difficulty === 'é«˜çº§') {
        this.currentQuestions = generateQuestionsFromTemplates(OLYMPIC_TEMPLATES, totalQuestions);
      } else {
        const baseQuestions = generateQuestionsFromTemplates(BASE_TEMPLATES, 4);
        const olympicQuestions = generateQuestionsFromTemplates(OLYMPIC_TEMPLATES, 2);
        this.currentQuestions = [...baseQuestions, ...olympicQuestions];
        for (let i = this.currentQuestions.length - 1; i > 0; i--) {
          const j = Math.floor(Math.random() * (i + 1));
          [this.currentQuestions[i], this.currentQuestions[j]] = [this.currentQuestions[j], this.currentQuestions[i]];
        }
      }
      this.renderQuestions();
    },

    renderQuestions: function() {
      const container = document.getElementById('questionsContainer');
      let html = '';
      this.currentQuestions.forEach((q, idx) => {
        let statusClass = 'pending-badge', statusText = 'â³ å¾…æ‰¹';
        if(q.isCorrect === true) { statusClass = 'correct-badge'; statusText = 'âœ… æ­£ç¡®'; }
        else if(q.isCorrect === false) { statusClass = 'wrong-badge'; statusText = 'âŒ é”™è¯¯'; }

        const inputDisabled = (!this.active && this.secondsLeft <= 0) || this.submitted ? 'disabled' : '';

        html += `<div class="ques-item">
          <div class="ques-header">
            <span class="ques-text">${idx+1}. ${q.text}</span>
            <span class="meta-badge">${q.mainCat} Â· ${q.subCat}</span>
          </div>
          <div class="answer-area">
            <input class="ans-input" type="text" id="ans_${idx}" placeholder="ç­”æ¡ˆ" value="${q.userAnswer||''}" ${inputDisabled}>
            <span class="result-badge ${statusClass}">${statusText}</span>
          </div>
          ${q.isCorrect !== null ? `
          <div class="hint-section">
            <div class="child-hint">${q.childHint}</div>
            <button class="parent-btn" onclick="toggleParentHint(${idx})">ğŸ” å®¶é•¿æŸ¥çœ‹è§£æ</button>
            <div class="parent-hint hidden" id="parentHint_${idx}">ğŸ“ ${q.parentHint}</div>
          </div>
          ` : ''}
        </div>`;
      });
      container.innerHTML = html;
    },

    submitAll: function() {
      this.currentQuestions.forEach((q, idx) => {
        const input = document.getElementById(`ans_${idx}`);
        if(input) q.userAnswer = input.value.trim();
      });

      let correct = 0;
      this.currentQuestions.forEach(q => {
        let right = false;
        if(typeof q.ans === 'number') {
          right = Math.abs(parseFloat(q.userAnswer) - q.ans) < 0.01;
        } else {
          right = q.userAnswer === q.ans;
        }
        q.isCorrect = right;
        if(right) correct++;
        else if(q.userAnswer) this.addMistake(q);
      });
      
      const percent = ((correct/this.currentQuestions.length)*100).toFixed(1);
      this.addLog(`ğŸ“Š æäº¤ç­”æ¡ˆ - æ­£ç¡®ç‡: ${correct}/${this.currentQuestions.length} (${percent}%)`);
      
      if(this.timerInterval) {
        clearInterval(this.timerInterval);
        this.timerInterval = null;
      }
      this.active = false;
      this.submitted = true;
      document.getElementById('submitBtn').disabled = true;
      document.getElementById('startBtn').disabled = false;
      this.renderQuestions();
    },

    addMistake: function(q) {
      const exists = this.mistakeList.some(m => m.text === q.text && m.correctAns === q.ans);
      if (!exists) {
        this.mistakeList.unshift({
          text: q.text,
          correctAns: q.ans,
          mainCat: q.mainCat,
          subCat: q.subCat,
          childHint: q.childHint,
          parentHint: q.parentHint,
          date: new Date().toLocaleTimeString()
        });
        if(this.mistakeList.length > 20) this.mistakeList.pop();
        this.saveMistakes();
        this.updateMistakeUI();
      }
    },

    updateMistakeUI: function() {
      const div = document.getElementById('mistakeContainer');
      if(!this.mistakeList.length) {
        div.innerHTML = 'ğŸ“• è¿˜æ²¡æœ‰é”™é¢˜ï¼Œç»§ç»­åŠ æ²¹ï¼';
        return;
      }
      let html = '<strong>ğŸ“• é”™é¢˜æœ¬ (æœ€è¿‘5æ¡)</strong>';
      this.mistakeList.slice(0,5).forEach(m => {
        html += `<div class="mistake-item">
          <div><b>${m.text}</b> æ­£ç¡®ç­”æ¡ˆ: ${m.correctAns} [${m.subCat}]</div>
          <div class="child-hint" style="margin-top:8px;">ğŸ¤” ${m.childHint}</div>
          <div class="parent-hint" style="margin-top:5px;">ğŸ“ ${m.parentHint}</div>
          <div style="font-size:0.8rem; color:#999; margin-top:5px;">${m.date}</div>
        </div>`;
      });
      div.innerHTML = html;
    },

    addLog: function(msg) {
      const logDiv = document.getElementById('historyLog');
      const entry = document.createElement('div');
      entry.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
      logDiv.prepend(entry);
      if(logDiv.children.length > 8) logDiv.removeChild(logDiv.lastChild);
    },

    clearMistakes: function() {
      this.mistakeList = [];
      this.saveMistakes();
      this.updateMistakeUI();
      this.addLog('ğŸ—‘ï¸ æ¸…ç©ºé”™é¢˜æœ¬');
    },

    exportMistakes: function() {
      alert(JSON.stringify(this.mistakeList, null, 2));
    },

    addDemoMistake: function() {
      this.addMistake({
        text: "3Ã—?+2=11",
        ans: 3,
        mainCat: "åŸºç¡€é¢˜",
        subCat: "æ–¹ç¨‹å…¥é—¨",
        childHint: "ğŸ¤” å…ˆæƒ³3Ã—?ç­‰äºå¤šå°‘ï¼Œå†ç®—?æ˜¯å¤šå°‘ã€‚",
        parentHint: "3x+2=11 â†’ 3x=9 â†’ x=3"
      });
    },

    saveMistakes: function() {
      localStorage.setItem('mathMistakes', JSON.stringify(this.mistakeList));
    },

    loadMistakes: function() {
      const data = localStorage.getItem('mathMistakes');
      if(data) this.mistakeList = JSON.parse(data);
      this.updateMistakeUI();
    }
  };

  window.onload = () => app.init();
})();
</script>
</body>
</html>
